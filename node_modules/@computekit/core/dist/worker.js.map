{"version":3,"sources":["../src/utils.ts","../src/worker/runtime.ts"],"names":[],"mappings":"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","file":"worker.js","sourcesContent":["/**\r\n * ComputeKit Utilities\r\n * Helper functions for the WASM + Worker toolkit\r\n */\r\n\r\n/**\r\n * Generate a unique ID\r\n */\r\nexport function generateId(): string {\r\n  return `${Date.now().toString(36)}-${Math.random().toString(36).slice(2, 11)}`;\r\n}\r\n\r\n/**\r\n * Check if running in a Web Worker context\r\n */\r\nexport function isWorkerContext(): boolean {\r\n  return (\r\n    typeof self !== 'undefined' &&\r\n    typeof Window === 'undefined' &&\r\n    typeof self.postMessage === 'function'\r\n  );\r\n}\r\n\r\n/**\r\n * Check if running in a browser context\r\n */\r\nexport function isBrowserContext(): boolean {\r\n  return typeof window !== 'undefined' && typeof document !== 'undefined';\r\n}\r\n\r\n/**\r\n * Check if SharedArrayBuffer is available\r\n */\r\nexport function isSharedArrayBufferAvailable(): boolean {\r\n  try {\r\n    return typeof SharedArrayBuffer !== 'undefined';\r\n  } catch {\r\n    return false;\r\n  }\r\n}\r\n\r\n/**\r\n * Check if WASM is supported\r\n */\r\nexport function isWasmSupported(): boolean {\r\n  try {\r\n    if (typeof WebAssembly === 'object') {\r\n      const module = new WebAssembly.Module(\r\n        Uint8Array.of(0x0, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00)\r\n      );\r\n      return module instanceof WebAssembly.Module;\r\n    }\r\n  } catch {\r\n    // WASM not supported\r\n  }\r\n  return false;\r\n}\r\n\r\n/**\r\n * Get the number of logical processors\r\n */\r\nexport function getHardwareConcurrency(): number {\r\n  if (typeof navigator !== 'undefined' && navigator.hardwareConcurrency) {\r\n    return navigator.hardwareConcurrency;\r\n  }\r\n  return 4; // Reasonable default\r\n}\r\n\r\n/**\r\n * Create a deferred promise\r\n */\r\nexport interface Deferred<T> {\r\n  promise: Promise<T>;\r\n  resolve: (value: T | PromiseLike<T>) => void;\r\n  reject: (reason?: unknown) => void;\r\n}\r\n\r\nexport function createDeferred<T>(): Deferred<T> {\r\n  let resolve!: (value: T | PromiseLike<T>) => void;\r\n  let reject!: (reason?: unknown) => void;\r\n\r\n  const promise = new Promise<T>((res, rej) => {\r\n    resolve = res;\r\n    reject = rej;\r\n  });\r\n\r\n  return { promise, resolve, reject };\r\n}\r\n\r\n/**\r\n * Create a timeout promise\r\n */\r\nexport function createTimeout(ms: number, message?: string): Promise<never> {\r\n  return new Promise((_, reject) => {\r\n    setTimeout(() => {\r\n      reject(new Error(message || `Operation timed out after ${ms}ms`));\r\n    }, ms);\r\n  });\r\n}\r\n\r\n/**\r\n * Race a promise against a timeout\r\n */\r\nexport async function withTimeout<T>(\r\n  promise: Promise<T>,\r\n  ms: number,\r\n  message?: string\r\n): Promise<T> {\r\n  return Promise.race([promise, createTimeout(ms, message)]);\r\n}\r\n\r\n/**\r\n * Detect transferable objects in data\r\n */\r\nexport function findTransferables(data: unknown): Transferable[] {\r\n  const transferables: Transferable[] = [];\r\n  const seen = new WeakSet();\r\n\r\n  function traverse(obj: unknown): void {\r\n    if (obj === null || typeof obj !== 'object') return;\r\n    if (seen.has(obj as object)) return;\r\n    seen.add(obj as object);\r\n\r\n    if (obj instanceof ArrayBuffer) {\r\n      transferables.push(obj);\r\n      return;\r\n    }\r\n\r\n    if (ArrayBuffer.isView(obj)) {\r\n      transferables.push(obj.buffer);\r\n      return;\r\n    }\r\n\r\n    if (obj instanceof MessagePort) {\r\n      transferables.push(obj);\r\n      return;\r\n    }\r\n\r\n    if (typeof ImageBitmap !== 'undefined' && obj instanceof ImageBitmap) {\r\n      transferables.push(obj);\r\n      return;\r\n    }\r\n\r\n    if (typeof OffscreenCanvas !== 'undefined' && obj instanceof OffscreenCanvas) {\r\n      transferables.push(obj);\r\n      return;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      obj.forEach(traverse);\r\n      return;\r\n    }\r\n\r\n    if (obj instanceof Map) {\r\n      obj.forEach((value, key) => {\r\n        traverse(key);\r\n        traverse(value);\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (obj instanceof Set) {\r\n      obj.forEach(traverse);\r\n      return;\r\n    }\r\n\r\n    Object.values(obj).forEach(traverse);\r\n  }\r\n\r\n  traverse(data);\r\n  return transferables;\r\n}\r\n\r\n/**\r\n * Clone data, detaching transferables\r\n */\r\nexport function cloneForTransfer<T>(data: T): { data: T; transfer: Transferable[] } {\r\n  const transfer = findTransferables(data);\r\n  return { data, transfer };\r\n}\r\n\r\n/**\r\n * Create a typed event emitter\r\n */\r\nexport type EventHandler<T = unknown> = (data: T) => void;\r\n\r\nexport class EventEmitter<TEvents extends Record<string, unknown>> {\r\n  private handlers = new Map<keyof TEvents, Set<EventHandler>>();\r\n\r\n  on<K extends keyof TEvents>(event: K, handler: EventHandler<TEvents[K]>): () => void {\r\n    if (!this.handlers.has(event)) {\r\n      this.handlers.set(event, new Set());\r\n    }\r\n    this.handlers.get(event)!.add(handler as EventHandler);\r\n\r\n    // Return unsubscribe function\r\n    return () => this.off(event, handler);\r\n  }\r\n\r\n  off<K extends keyof TEvents>(event: K, handler: EventHandler<TEvents[K]>): void {\r\n    this.handlers.get(event)?.delete(handler as EventHandler);\r\n  }\r\n\r\n  emit<K extends keyof TEvents>(event: K, data: TEvents[K]): void {\r\n    this.handlers.get(event)?.forEach((handler) => {\r\n      try {\r\n        handler(data);\r\n      } catch (err) {\r\n        console.error(`Error in event handler for ${String(event)}:`, err);\r\n      }\r\n    });\r\n  }\r\n\r\n  removeAllListeners(event?: keyof TEvents): void {\r\n    if (event) {\r\n      this.handlers.delete(event);\r\n    } else {\r\n      this.handlers.clear();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Simple LRU cache\r\n */\r\nexport class LRUCache<K, V> {\r\n  private cache = new Map<K, V>();\r\n  private maxSize: number;\r\n\r\n  constructor(maxSize: number = 100) {\r\n    this.maxSize = maxSize;\r\n  }\r\n\r\n  get(key: K): V | undefined {\r\n    const value = this.cache.get(key);\r\n    if (value !== undefined) {\r\n      // Move to end (most recently used)\r\n      this.cache.delete(key);\r\n      this.cache.set(key, value);\r\n    }\r\n    return value;\r\n  }\r\n\r\n  set(key: K, value: V): void {\r\n    if (this.cache.has(key)) {\r\n      this.cache.delete(key);\r\n    } else if (this.cache.size >= this.maxSize) {\r\n      // Delete oldest (first) entry\r\n      const firstKey = this.cache.keys().next().value;\r\n      if (firstKey !== undefined) {\r\n        this.cache.delete(firstKey);\r\n      }\r\n    }\r\n    this.cache.set(key, value);\r\n  }\r\n\r\n  has(key: K): boolean {\r\n    return this.cache.has(key);\r\n  }\r\n\r\n  delete(key: K): boolean {\r\n    return this.cache.delete(key);\r\n  }\r\n\r\n  clear(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  get size(): number {\r\n    return this.cache.size;\r\n  }\r\n}\r\n\r\n/**\r\n * Serialize function to string for worker\r\n */\r\n// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\r\nexport function serializeFunction(fn: Function): string {\r\n  return fn.toString();\r\n}\r\n\r\n/**\r\n * Estimate the byte size of a value for structured cloning.\r\n * This is an approximation useful for debugging and performance monitoring.\r\n */\r\nexport function estimatePayloadSize(value: unknown): number {\r\n  if (value === null || value === undefined) return 0;\r\n  if (typeof value === 'boolean') return 4;\r\n  if (typeof value === 'number') return 8;\r\n  if (typeof value === 'string') return value.length * 2; // UTF-16\r\n\r\n  if (value instanceof ArrayBuffer) return value.byteLength;\r\n  if (ArrayBuffer.isView(value)) return value.byteLength;\r\n  if (value instanceof Blob) return value.size;\r\n\r\n  const seen = new WeakSet<object>();\r\n\r\n  function traverse(obj: unknown): number {\r\n    if (obj === null || typeof obj !== 'object') {\r\n      if (typeof obj === 'boolean') return 4;\r\n      if (typeof obj === 'number') return 8;\r\n      if (typeof obj === 'string') return (obj as string).length * 2;\r\n      return 0;\r\n    }\r\n\r\n    if (seen.has(obj)) return 0; // Avoid infinite loops\r\n    seen.add(obj);\r\n\r\n    if (obj instanceof ArrayBuffer) return obj.byteLength;\r\n    if (ArrayBuffer.isView(obj)) return obj.byteLength;\r\n    if (obj instanceof Blob) return obj.size;\r\n    if (obj instanceof Date) return 8;\r\n    if (obj instanceof RegExp) return obj.source.length * 2;\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.reduce((sum, item) => sum + traverse(item), 0);\r\n    }\r\n\r\n    if (obj instanceof Map) {\r\n      let size = 0;\r\n      obj.forEach((val, key) => {\r\n        size += traverse(key) + traverse(val);\r\n      });\r\n      return size;\r\n    }\r\n\r\n    if (obj instanceof Set) {\r\n      let size = 0;\r\n      obj.forEach((val) => {\r\n        size += traverse(val);\r\n      });\r\n      return size;\r\n    }\r\n\r\n    // Plain object\r\n    return Object.entries(obj).reduce(\r\n      (sum, [key, val]) => sum + key.length * 2 + traverse(val),\r\n      0\r\n    );\r\n  }\r\n\r\n  return traverse(value);\r\n}\r\n\r\n/**\r\n * Format bytes to human-readable string\r\n */\r\nexport function formatBytes(bytes: number): string {\r\n  if (bytes === 0) return '0 B';\r\n  const k = 1024;\r\n  const sizes = ['B', 'KB', 'MB', 'GB'];\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n  return `${(bytes / Math.pow(k, i)).toFixed(i > 0 ? 1 : 0)} ${sizes[i]}`;\r\n}\r\n\r\n/**\r\n * Logger utility\r\n */\r\nexport interface Logger {\r\n  debug(...args: unknown[]): void;\r\n  info(...args: unknown[]): void;\r\n  warn(...args: unknown[]): void;\r\n  error(...args: unknown[]): void;\r\n}\r\n\r\nexport function createLogger(prefix: string, enabled: boolean = false): Logger {\r\n  const noop = () => {};\r\n  const log = (level: string) =>\r\n    enabled ? (...args: unknown[]) => console.log(`[${prefix}:${level}]`, ...args) : noop;\r\n\r\n  return {\r\n    debug: log('debug'),\r\n    info: log('info'),\r\n    warn: enabled\r\n      ? (...args: unknown[]) => console.warn(`[${prefix}:warn]`, ...args)\r\n      : noop,\r\n    error: (...args: unknown[]) => console.error(`[${prefix}:error]`, ...args),\r\n  };\r\n}\r\n","/**\r\n * ComputeKit Worker Runtime\r\n * Code that runs inside Web Workers\r\n */\r\n\r\nimport type {\r\n  WorkerMessage,\r\n  ExecutePayload,\r\n  ResultPayload,\r\n  ErrorPayload,\r\n  ComputeProgress,\r\n} from '../types';\r\n\r\nimport { generateId, findTransferables, estimatePayloadSize } from '../utils';\r\n\r\n/** Registry of compute functions available in the worker */\r\n// eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\r\nconst functionRegistry = new Map<string, Function>();\r\n\r\n/** Current task context for progress reporting */\r\nlet currentTaskId: string | null = null;\r\n\r\n/**\r\n * Report progress from within a compute function\r\n */\r\nexport function reportProgress(progress: Partial<ComputeProgress>): void {\r\n  if (!currentTaskId) {\r\n    console.warn('reportProgress called outside of compute function');\r\n    return;\r\n  }\r\n\r\n  const message: WorkerMessage = {\r\n    id: generateId(),\r\n    type: 'progress',\r\n    payload: {\r\n      taskId: currentTaskId,\r\n      progress: {\r\n        percent: progress.percent ?? 0,\r\n        phase: progress.phase,\r\n        estimatedTimeRemaining: progress.estimatedTimeRemaining,\r\n        data: progress.data,\r\n      },\r\n    },\r\n    timestamp: Date.now(),\r\n  };\r\n\r\n  self.postMessage(message);\r\n}\r\n\r\n/**\r\n * Register a compute function in the worker\r\n */\r\nexport function registerFunction(\r\n  name: string,\r\n  // eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\r\n  fn: Function\r\n): void {\r\n  functionRegistry.set(name, fn);\r\n}\r\n\r\n/**\r\n * Execute a registered function\r\n */\r\nasync function executeFunction(functionName: string, input: unknown): Promise<unknown> {\r\n  const fn = functionRegistry.get(functionName);\r\n\r\n  if (!fn) {\r\n    throw new Error(`Function \"${functionName}\" not found in worker`);\r\n  }\r\n\r\n  return fn(input);\r\n}\r\n\r\n/**\r\n * Handle incoming messages from the main thread\r\n */\r\nasync function handleMessage(event: MessageEvent<WorkerMessage>): Promise<void> {\r\n  const { id, type, payload } = event.data;\r\n\r\n  if (type === 'execute') {\r\n    const { functionName, input } = payload as ExecutePayload;\r\n    const startTime = performance.now();\r\n\r\n    // Set current task for progress reporting\r\n    currentTaskId = id;\r\n\r\n    try {\r\n      const result = await executeFunction(functionName, input);\r\n      const duration = performance.now() - startTime;\r\n\r\n      // Find transferable objects in result\r\n      const transfer = findTransferables(result);\r\n\r\n      // Estimate output size for debugging\r\n      const outputSize = estimatePayloadSize(result);\r\n\r\n      const response: WorkerMessage<ResultPayload> = {\r\n        id,\r\n        type: 'result',\r\n        payload: {\r\n          data: result,\r\n          duration,\r\n          outputSize,\r\n        },\r\n        timestamp: Date.now(),\r\n      };\r\n\r\n      self.postMessage(response, transfer as Transferable[]);\r\n    } catch (err) {\r\n      const error = err instanceof Error ? err : new Error(String(err));\r\n      const duration = performance.now() - startTime;\r\n\r\n      const response: WorkerMessage<ErrorPayload> = {\r\n        id,\r\n        type: 'error',\r\n        payload: {\r\n          message: error.message,\r\n          stack: error.stack,\r\n          functionName,\r\n          duration,\r\n        },\r\n        timestamp: Date.now(),\r\n      };\r\n\r\n      self.postMessage(response);\r\n    } finally {\r\n      currentTaskId = null;\r\n    }\r\n  } else if (type === 'init') {\r\n    // Handle initialization if needed\r\n    const response: WorkerMessage = {\r\n      id,\r\n      type: 'ready',\r\n      timestamp: Date.now(),\r\n    };\r\n    self.postMessage(response);\r\n  }\r\n}\r\n\r\n/**\r\n * Initialize the worker runtime\r\n */\r\nexport function initWorkerRuntime(): void {\r\n  self.onmessage = handleMessage;\r\n\r\n  // Signal that worker is ready\r\n  const readyMessage: WorkerMessage = {\r\n    id: generateId(),\r\n    type: 'ready',\r\n    timestamp: Date.now(),\r\n  };\r\n  self.postMessage(readyMessage);\r\n}\r\n\r\n// Export for use in worker entry point\r\nexport { functionRegistry };\r\n"]}